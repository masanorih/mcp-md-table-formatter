# なぜ MCP で実装するのか

このドキュメントでは、Markdown テーブル整形ツールを MCP（Model Context Protocol）サーバーとして実装する理由を、Claude Code が持つ他の機能と比較しながら解説する。

## 前提: このツールが解決する問題

Markdown テーブルの列幅を、全角（CJK）文字と半角文字の表示幅の違いを考慮して揃える。

例えば「名前」は表示幅 4、「Name」も表示幅 4 だが、文字数はそれぞれ 2 と 4 で異なる。この差分を正しく計算してスペースでパディングする必要がある。

## Claude Code の主な機能

比較対象となる Claude Code の機能を簡単に紹介する。

### CLAUDE.md（プロンプト指示）

プロジェクトや個人の設定ファイルに、Claude への指示を自然言語で記述する仕組み。Claude はこの指示に従って動作する。

### Hooks（フック）

Claude Code がツール（ファイル書き込みなど）を実行する前後に、指定したシェルコマンドを自動実行する仕組み。

### Subagents（サブエージェント）

Claude が複雑なタスクを処理する際に、別の Claude インスタンス（サブエージェント）を起動して作業を委譲する仕組み。

### Skills（スキル / スラッシュコマンド）

`/commit` のようにユーザーが明示的に呼び出すコマンド。内部的にはプロンプトとして展開される。

### MCP（Model Context Protocol）

外部プロセスとして動作するサーバーが提供するツールを、Claude が自律的に呼び出せる仕組み。計算やファイル操作などの決定的な処理を外部プログラムに委譲できる。

## 比較

### 1. CLAUDE.md に整形ルールを記述する

「テーブルの列幅を揃えて。全角文字は幅 2 で計算して」と指示する方法。

- 追加インストール不要で最も手軽
- ただし LLM はトークン単位で処理するため、1 文字ずつ幅を数えて足し算する作業が構造的に苦手
- 数え間違いが頻繁に起き、列がズレる
- 毎回正確な結果が得られる保証がない

### 2. Hooks でファイル書き込み後に自動実行する

`.md` ファイルへの Write / Edit 操作の後に、整形スクリプトを自動実行する方法。

- 整形処理自体は Python が行うため正確
- Claude 側の判断が不要で、確実に毎回実行される
- ただし、テーブルが含まれない `.md` への書き込みでも毎回実行される
- Claude は Hook の存在を認識しないため、整形結果を踏まえた応答（「テーブルを整形しました」など）ができない

### 3. Subagents に整形を委譲する

別の Claude インスタンスを起動して、テーブル整形を任せる方法。

- サブエージェントも LLM であるため、文字幅の正確な計算は同様に苦手
- サブエージェント内で Bash 経由で外部スクリプトを実行すれば正確な整形は可能だが、MCP と比べて回りくどい
- サブエージェントの起動にはオーバーヘッドがかかる

### 4. Skills（スラッシュコマンド）として定義する

`/format-table` のようなコマンドを定義する方法。

- ユーザーが明示的に呼ぶ必要があり、自動実行されない
- 中身はプロンプトとして展開されるため、正確な計算には結局外部ツールの呼び出しが必要
- 「テーブルを書いたら自動で整形する」というワークフローには向かない

### 5. MCP ツールとして実装する（本プロジェクト）

外部の Python プロセスが整形処理を行い、Claude がツールとして呼び出す方法。

- 文字幅の計算は Python（`unicodedata.east_asian_width`）が行うため正確
- Claude が「テーブルを書いたから整形しよう」と自律的に判断して呼び出せる
- テーブルがない場合は呼ばれないため、無駄な実行がない
- 整形結果を Claude が受け取れるため、結果を踏まえた応答が可能

## まとめ

| 観点                           | CLAUDE.md | Hooks | Subagents | Skills | MCP |
| ------------------------------ | --------- | ----- | --------- | ------ | --- |
| 全角幅を正確に計算できる       | x         | o     | x         | x      | o   |
| Claude が自律的に呼び出せる    | -         | x     | o         | x      | o   |
| 不要な場合は実行をスキップする | o         | x     | o         | o      | o   |
| Claude が実行結果を認識できる  | -         | x     | o         | -      | o   |

MCP は「LLM の判断力」と「プログラムの計算精度」を組み合わせられる唯一の選択肢である。

- Hooks は正確だが、Claude が存在を認識できず、条件に関係なく毎回実行される
- Subagents は Claude が判断して呼べるが、中身が LLM であるため計算が不正確
- MCP は Claude の判断で必要な時だけ呼び出し、実際の計算は Python が正確に実行する

この「いつ実行するかは LLM が判断し、何を実行するかはプログラムが担う」という役割分担が、MCP の本質的な強みである。
